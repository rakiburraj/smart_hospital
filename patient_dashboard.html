{% extends 'base.html' %}
{% load static %}
{% block title %}Patient Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'home.css' %}">

<div class="container mt-4">

    
    <div class="card p-4 shadow-sm mb-4 text-center" style="max-width: 700px; margin: auto;">
        <h2>Welcome to the Patient Dashboard, {{ patient_name }}!</h2>
        <p class="text-muted">Browse departments, view doctors, and view your consultation history.</p>

        <div class="mt-3">
            {% if profile_exists %}
                <a href="{% url 'profile_detail' %}" class="btn btn-success btn-lg mx-1">View Profile</a>
                <a href="{% url 'edit_patient_profile' %}" class="btn btn-warning btn-lg mx-1">Edit Profile</a>
            {% else %}
                <a href="{% url 'create_patient_profile' %}" class="btn btn-primary btn-lg mx-1">Create Profile</a>
            {% endif %}
        </div>
    </div>

    
    <h3 class="mb-4">Departments</h3>
    <div class="row mb-5">
        {% for dept in departments %}
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center">
                    <h5 class="card-title">{{ dept.name }}</h5>
                    <p class="card-text">{{ dept.description|truncatewords:20 }}</p>
                    <a href="{% url 'department_doctors' dept.id %}" class="btn btn-primary">View Doctors</a>
                </div>
            </div>
        </div>
        {% empty %}
        <p>No departments found.</p>
        {% endfor %}
    </div>

   
    <h3 class="mb-3">Consultation History</h3>

    {% if appointments %}
        <div class="accordion" id="historyAccordion">
            {% for app in appointments %}
            <div class="accordion-item mb-2">
                <h2 class="accordion-header" id="heading{{ app.id }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ app.id }}" aria-expanded="false" aria-controls="collapse{{ app.id }}">
                        Appointment with Dr. {{ app.doctor.name }} on {{ app.date }}
                    </button>
                </h2>
                <div id="collapse{{ app.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ app.id }}" data-bs-parent="#historyAccordion">
                    <div class="accordion-body text-start">

                       
                        {% if app.notes %}
                            <p><strong>Doctor Notes:</strong> {{ app.notes }}</p>
                        {% endif %}

                       
                        {% with prescriptions=app.prescription_set.all %}
                            {% if prescriptions %}
                                <p><strong>Prescriptions:</strong></p>
                                <div class="d-flex flex-wrap gap-3 mb-3">
                                    {% for p in prescriptions %}
                                        {% if p.prescription_image %}
                                            <div class="card" style="width: 150px;">
                                                <img src="{{ p.prescription_image.url }}" class="card-img-top" alt="Prescription">
                                                {% if p.notes %}
                                                    <div class="card-body p-2">
                                                        <p class="card-text small">{{ p.notes|truncatewords:10 }}</p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p><span class="text-muted">No prescriptions uploaded yet.</span></p>
                            {% endif %}
                        {% endwith %}

                        
                        {% with tests=app.test_set.all %}
                            {% if tests %}
                                <p><strong>Tests:</strong></p>
                                <ul>
                                    {% for t in tests %}
                                        <li>{{ t.test_name }}
                                            {% if t.result_file %}
                                                - <a href="{{ t.result_file.url }}" target="_blank">View Report</a>
                                            {% else %}
                                                - <span class="text-muted">Report not yet uploaded</span>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        {% endwith %}

                        
                        <div class="mt-3">
                            {% if app.feedback %}
                                <p><strong>Your Feedback:</strong></p>
                                <p>Rating: 
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= app.feedback.rating %}
                                            <span style="color:#FFD700;">&#9733;</span>
                                        {% else %}
                                            <span style="color:#ccc;">&#9733;</span>
                                        {% endif %}
                                    {% endfor %}
                                    ({{ app.feedback.rating }}/5)
                                </p>
                                {% if app.feedback.comment %}
                                    <p>Comment: {{ app.feedback.comment }}</p>
                                {% endif %}
                            {% else %}
                                <form method="POST" action="{% url 'submit_feedback' app.id %}">
                                    {% csrf_token %}
                                    <label for="rating{{ app.id }}">Rate this doctor:</label>
                                    <select name="rating" id="rating{{ app.id }}" class="form-select mb-2" required>
                                        <option value="">--Select Rating--</option>
                                        <option value="1">1 - Poor</option>
                                        <option value="2">2 - Fair</option>
                                        <option value="3">3 - Good</option>
                                        <option value="4">4 - Very Good</option>
                                        <option value="5">5 - Excellent</option>
                                    </select>
                                    <textarea name="comment" class="form-control mb-2" placeholder="Optional comment"></textarea>
                                    <button type="submit" class="btn btn-success">Submit Feedback</button>
                                </form>
                            {% endif %}
                        </div>

                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-muted">You have not consulted a doctor yet.</p>
    {% endif %}

</div>
{% endblock %}
