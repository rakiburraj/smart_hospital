{% extends 'base.html' %}
{% load static %}

{% block title %}Patient Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'home.css' %}">

<div class="container mt-4">

    
    <div class="card p-4 shadow-sm mb-4 text-center" style="max-width: 700px; margin: auto;">
        <h2>Welcome to the Patient Profile, {{ patient_name }}!</h2>

        <div class="mt-3">
            {% if profile_exists %}
                <a href="{% url 'profile_detail' patient.id %}" class="btn btn-success btn-lg mx-1">View Profile</a>
            {% endif %}
        </div>
    </div>

    
    <h3 class="mb-3">Consultation History</h3>

    {% if appointments %}
        <div class="accordion" id="historyAccordion">
            {% for app in appointments %}
                <div class="accordion-item mb-2">
                    <h2 class="accordion-header" id="heading{{ app.id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ app.id }}" aria-expanded="false" aria-controls="collapse{{ app.id }}">
                            Appointment with Dr. {{ app.doctor.name }} on {{ app.date }}
                        </button>
                    </h2>
                    <div id="collapse{{ app.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ app.id }}" data-bs-parent="#historyAccordion">
                        <div class="accordion-body text-start">

                            
                            {% if app.notes %}
                                <p><strong>Doctor Notes:</strong> {{ app.notes }}</p>
                            {% endif %}

                           
                            {% with prescriptions=app.prescription_set.all %}
                                {% if prescriptions %}
                                    <p><strong>Prescriptions:</strong></p>
                                    <div class="d-flex flex-wrap gap-3 mb-3">
                                        {% for p in prescriptions %}
                                            {% if p.prescription_image %}
                                                <div class="card" style="width: 150px;">
                                                    <img src="{{ p.prescription_image.url }}" class="card-img-top" alt="Prescription">
                                                    {% if p.notes %}
                                                        <div class="card-body p-2">
                                                            <p class="card-text small">{{ p.notes|truncatewords:10 }}</p>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p><span class="text-muted">No prescriptions uploaded yet.</span></p>
                                {% endif %}
                            {% endwith %}

                           
                            {% with tests=app.test_set.all %}
                                {% if tests %}
                                    <p><strong>Tests:</strong></p>
                                    <ul>
                                        {% for t in tests %}
                                            <li>{{ t.test_name }}
                                                {% if t.result_file %}
                                                    - <a href="{{ t.result_file.url }}" target="_blank">View Report</a>
                                                {% else %}
                                                    - <span class="text-muted">Report not yet uploaded</span>
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p><span class="text-muted">No tests for this appointment.</span></p>
                                {% endif %}
                            {% endwith %}

                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-muted">You have not consulted a doctor yet.</p>
    {% endif %}

</div>
{% endblock %}
